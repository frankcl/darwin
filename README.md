# darwin
爬虫系统：达尔文树皮蜘蛛，能结出世界上最大最牢固的网

## 特点

* 支持自定义脚本，针对特定站点定制抽链和结构化逻辑
* 支持域名/站点粒度抓取调度：具备礼貌性控制，管理站点/域名粒度单位时间并发度
* 支持文本（HTML、JSON等）、资源（图片和视频）、流媒体（M3U8流）等数据抓取
* 多层次爬虫数据管理：应用->计划->任务->抓取记录

## 模块

### 1. darwin-common 公共代码
- [x] 数据模型定义
- [x] 并发单元计算器
- [x] 公共工具定义

### 2. darwin-queue 并发控制及多级队列
- [x] 并发控制：管理并发单元（站点/域名）当前抓取连接生命周期
- [x] 多级队列：并发单元抓取调度，保证优先级、并发度及平滑度

### 3. darwin-parser 抓取内容解析
- [x] 脚本解析引擎框架：支持Groovy和JavaScript
- [x] 脚本解析服务：使用用户定义脚本对抓取内容进行解析

### 4. darwin-service 服务定义和实现
- [x] 应用服务
- [x] 应用用户管理服务
- [x] 计划服务
- [x] 任务服务
- [x] 代理管理服务
- [x] 规则及规则分组服务
- [x] 抓取记录服务

### 5. darwin-spider 内容爬取
- [x] 网页抓取：HTML、JSON及其他文本抓取
- [x] 资源抓取：图片、视频及PDF等资源抓取
- [x] 直播流抓取：M3U8点播资源抓取

### 6. darwin-scheduler 抓取任务调度
- [x] 周期性任务调度
- [x] URL队列调度

### 7. darwin-web 爬虫RESTFul服务
- [x] 应用服务接口
- [x] 应用用户管理接口
- [x] 计划服务接口
- [x] 任务服务接口
- [x] 代理服务接口
- [x] 规则及规则分组服务接口
- [x] 抓取记录服务接口

### 8. darwin-monitor 监控
- [x] 并发连接资源监控：清理过期并发连接
- [x] URL多级队列监控：清理过期任务及过期并发单元
- [x] 代理监控：定期刷新短效代理

### 9. darwin-log 切面日志
- [x] 切面日志配置，涉及URL、并发单元、任务和计划

## 架构原理

### 基本概念

* 应用：业务归属单位，所有爬虫计划、任务及链接归属于应用
* 计划：爬虫抓取计划，计划是任务的元数据定义，计划负责生成任务，一个计划归属于一个应用，包含一组规则及一系列种子URL，计划分2类
  * 一次性计划：计划根据种子列表和规则列表生成一次性爬虫任务，可重复填充种子重新生成爬虫任务
  * 周期性计划：计划根据调度周期对种子列表和规则列表反复生成爬虫任务，种子列表可复用
* 任务：数据抓取调度及归属单元，一个任务归属于计划及应用，包含一组规则及一系列种子URL，任务具备3级调度优先级：高、中、低，框架负责调度任务，抓取任务URL
* 规则：规则负责页面解析工作，包含匹配URL的正则表达式及解析页面的脚本，脚本支持Groovy和JavaScript，一个规则属于一个规则分组
* 规则分组：具备相同业务属性的规则归属同一分组
* 代理：代理IP，区分长效代理和短效代理
  * 长效代理：代理IP长期有效
  * 短效代理：代理IP具有有效时间
* URL记录：定义抓取URL、抓取结果及解析结果
* 并发单元：控制单位时间内的抓取并发数量，支持domain和host级别，框架通过并发单元控制对目标站点的抓取礼貌性

### darwin架构

![architecture](https://github.com/frankcl/darwin/blob/main/images/darwin%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)

* 数据存储层：负责基础数据存储，例如应用、计划、任务、规则、规则分组及URL记录等
  * URL记录：存储于MySQL和OTS（可根据数据量选择），下载内容存储于OSS
  * 任务记录：存储于MySQL和OTS（可根据数据量选择）
* 并发管理层：负责链接调度及站点抓取并发度控制
  * MultiQueue：以并发单元为粒度存储待抓取链接
    * 并发单元：可以是domain或host(默认domain)，相同并发单元链接存储在同一队列，利于控制对站点的抓取礼貌性
    * 关于锁：为了保证只有一个线程操作链接调度(入队和出队)，MultiQueue提供了全局入队锁和出队锁，只有获得锁的线程能够进行相关操作
  * ConcurrentManager：负责管理并发单元抓取连接池
    * 通过ConcurrentManager可获取并发单元当前正在抓取连接数，进而控制并发单元在同一时刻的抓取数量
    * ConcurrentManager中记录抓取连接的生命周期，连接过期将被移除(ConcurrentConnectionMonitor负责)，防止抓取处理异常造成并发单元连接池耗尽问题
* 数据服务层
  * 基础服务：对底层数据及业务操作的抽象和封装，涉及应用、计划、任务、规则、规则分组及URL记录等
  * 数据通知分发：负责数据完成通知
    * URLCompleteNotifier：链接抓取完成通知分发
    * JobCompleteNotifier：爬虫任务完成通知分发
* 调度抓取层：负责链接的调度和抓取
  * 周期性任务调度：负责为周期性计划定期生成任务，并将种子URL加入MultiQueue
  * URL链接调度：负责周期性地从MultiQueue中弹出链接，发往下游爬虫进行抓取
    * 抓取溢出：URL在调度队列中滞留过长时间（默认2小时），不抓取并将状态设置为OVERFLOW
  * URL抓取：负责接收上游链接调度发送的URL，对URL进行抓取，支持3类资源抓取
    * 文本抓取：抓取HTML/JSON文本资源，并利用规则进行结构化或抽链，并将抽链结果加入MultiQueue进行调度
    * 资源抓取：抓取图片、视频资源
    * 流抓取：抓取M3U8流媒体资源
* Web接口层：提供RESTFul形式的web接口，支持应用、计划、任务、规则、规则分组及URL记录等粒度操作
* 监控：一些后台线程，负责保障系统数据完备性和一致性
  * MultiQueueMonitor
    * 负责清理无效并发单元
    * 负责清理长期未处理链接
  * ConcurrentConnectionMonitor：负责清理并发单元超期未处理的抓取连接
  * ProxyMonitor：负责定期刷新短效代理

### 并发控制模型

![concurrent](https://github.com/frankcl/darwin/blob/main/images/darwin%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B.png)

并发单元：负责控制单位时间内对目标站点的抓取并发度，目标站点控制粒度支持domain和host，例如对sina.com.cn(domain)控制每秒抓取数量不超过20个
* 相同并发单元的抓取链接存储于同一队列，队列遵守FIFO原则
* 相同并发单元将抓取链接分3个优先级队列进行存储，优先级分别为高、中、低，按照优先级进行抢占式调度，保证高优先级链接先于低优先级链接被调度

ConcurrentManager负责抓取连接TTL管理：以并发单元为单位，管理相同并发单元正在抓取链接的生命周期
* 获取并发单元当前抓取连接数，可用连接数，以及总连接数
* 对于抓取链接，并发单元可用连接数减一
* 对于抓取完成链接，并发单元可用连接数加一
* ConcurrentConnectionMonitor职责：超过TTL的连接将被强制清理，防止异常导致的并发单元连接池耗尽

### 调用时序关系

* 周期性计划调度时序

![period_time](https://github.com/frankcl/darwin/blob/main/images/darwin%E5%91%A8%E6%9C%9F%E5%9E%8B%E8%AE%A1%E5%88%92%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

1. 获取MultiQueue入队锁，如果失败则放弃本轮调度，否则转第2步
2. 获取当前需要进行调度的周期性计划，针对每个周期性计划进行以下步骤
   1. 根据计划构建任务，将任务添加入库
   2. 将任务种子URL加入MultiQueue
   3. 将任务种子URL添加入库
   4. 更新周期性计划下次调度时间
3. 释放MultiQueue入队锁

* URL调度时序

![url_schedule_time](https://github.com/frankcl/darwin/blob/main/images/darwin%E6%8A%93%E5%8F%96%E9%93%BE%E6%8E%A5%E8%B0%83%E5%BA%A6%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

1. 获取MultiQueue出队锁，如果失败则放弃本轮调度，否则转第2步
2. 从MultiQueue获取当前并发控制单元列表，针对每个并发控制单元进行以下处理
   1. 获取并发控制单元当前可用连接数，如果可用连接数小于等于0，则放弃并发控制单元本轮调度，否则进行下一步
   2. 根据可用连接数从MultiQueue中弹出抓取URL，针对每条URL，如果URL排队时间过长，转a），否则转b）
      1. 溢出处理：更新URL状态为OVERFLOW，发送URL完成通知，如果任务结束发送任务完成通知
      2. 正常处理：更新URL状态为抓取中，将URL信息发送到消息队列，等待下游爬虫抓取；并发单元链接TTL记录中添加抓取URL信息
3. 释放MultiQueue出队锁

* URL抓取时序

![url_fetch_time](https://github.com/frankcl/darwin/blob/main/images/darwin%E9%93%BE%E6%8E%A5%E6%8A%93%E5%8F%96%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

1. 从消息队列获取待抓取URL，进行以下处理
2. 根据URL信息选择抓取方案并执行数据抓取：文本抓取选择HTMLSpider，图片视频抓取选择ResourceSpider，直播流抓取选择StreamSpider
   1. HTMLSpider
      1. 获取URL关联任务，从任务关联规则列表中获取和抓取URL匹配的规则 
      2. 下载URL内容，并将下载结果存储到OSS
      3. 利用匹配规则解析下载内容，如果解析结果中有抽链结果，将抽链URL添加到MultiQueue和数据库中
   2. ResourceSpider
      1. 下载资源URL内容
      2. 将下载结果存入OSS
   3. StreamSpider
      1. 判断M3U8直播流是否结束，如果没有结束，则下载失败，否则进行下一步
      2. 执行FFMpeg命令，下载直播流视频
      3. 将下载结果存入OSS
3. URL完成分发处理
   1. 将抓取结果和URL信息更新入库 
   2. 从ConcurrentManager中移除连接信息
   3. 通过消息队列发送URL抓取结果
4. 判断URL所属任务是否结束，如果结束，执行以下步骤
   1. 更新关联任务状态为结束
   2. 通过消息队列发送结束任务信息